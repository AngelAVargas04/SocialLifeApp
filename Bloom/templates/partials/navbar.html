<!-- NAVIGATION BAR -->
  {% load static %}
  {% csrf_token %}
  <!-- Pass clubs data to JavaScript -->
  {{ clubs|json_script:"clubs-data" }}
  <nav class="relative bg-white py-3 px-4 shadow-sm flex items-center">
    <!-- Left side: Profile Picture and Search -->
    <div class="flex items-center gap-4 flex-shrink-0">
        <!-- Profile Picture with Dropdown -->
        {% if user.is_authenticated %}
        <div class="relative flex-shrink-0">
            <button id="profilePicBtn" class="relative flex rounded-full focus:outline-none cursor-pointer">
                {% if user.profile.profile_picture %}
                    <img src="{{ user.profile.profile_picture.url }}" alt="Profile" 
                        class="size-10 rounded-full bg-gray-800 outline -outline-offset-1 object-cover" />
                {% else %}
                    <div class="size-10 rounded-full bg-gray-300 outline -outline-offset-1 flex items-center justify-center text-gray-700 font-semibold text-sm">
                        {{ user.username|first|upper|default:"?" }}
                    </div>
                {% endif %}
            </button>
            
            <!-- Profile Dropdown Menu -->
            <div id="profileDropdown" class="hidden absolute left-0 top-full mt-2 w-64 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                <div class="p-4 border-b border-gray-200">
                    <p class="text-sm font-semibold text-gray-900">{{ user.username|default:"User" }}</p>
                    <p class="text-xs text-gray-500">{{ user.email|default:"" }}</p>
                </div>
                <div class="p-2">
                    <label for="profile-picture-upload" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded cursor-pointer">
                        Change Profile Picture
                        <input type="file" id="profile-picture-upload" accept="image/*" class="hidden" />
                    </label>
                    {% if user.profile.profile_picture %}
                    <button id="remove-profile-picture" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded cursor-pointer">
                        Remove Profile Picture
                    </button>
                    {% endif %}
                    <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-50 rounded">
                        Logout
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="max-w-sm w-full relative flex-shrink-0 flex items-center gap-2">
            <div class="relative flex-1">
                <label for="search" class="block mb-2.5 text-sm font-medium text-heading sr-only">Search</label>
                <div class="relative">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                        <svg class="w-4 h-4 text-body" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="m21 21-3.5-3.5M17 10a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z"/>
                        </svg>
                    </div>
                
                    <input type="search" id="search" 
                        class="rounded-full w-full p-2 ps-9 bg-neutral-secondary-medium border border-default-medium text-heading text-sm focus:ring-brand focus:border-brand shadow-xs placeholder:text-body" 
                        placeholder="Search for groups" autocomplete="off" />
                
                </div>
                
                <!-- Dropdown Menu -->
                <div id="searchDropdown" class="hidden absolute top-full left-0 right-0 mt-2 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-96 overflow-y-auto">
                <!-- Recent Searches Section -->
                <div id="recentSearches" class="border-b border-gray-200 p-3">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Recent Searches</h3>
                    </div>
                    <div id="recentSearchesList" class="space-y-1">
                        <!-- Recent searches will be populated here -->
                    </div>
                </div>
                
                <!-- Search Results Section -->
                <div id="searchResults" class="p-3">
                    <div id="searchResultsList" class="space-y-1">
                        <!-- Search results will be populated here -->
                    </div>
                    <div id="noResults" class="hidden text-center text-gray-500 py-4 text-sm">
                        No clubs found
                    </div>
                </div>
            </div>
            </div>
            
            <!-- Create a Group Button -->
            {% if user.is_authenticated %}
            <button id="createClubBtn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-full transition-colors whitespace-nowrap flex-shrink-0">
                Create a Group
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Center: Logo (absolutely positioned for perfect centering) -->
    <div class="absolute z-10" style="left: 50%; top: 50%; transform: translate(-50%, -50%);">
        <a href="{% url 'home' %}">
            <img src="{% static 'image/logo_Bloom_BW.svg' %}" alt="Bloom Logo" class="h-12" />
        </a>
    </div>

    <!-- Right side: Hello text or Login/Signup buttons (absolutely positioned to the right) -->
    <div class="absolute flex items-center" style="right: 1rem; top: 50%; transform: translateY(-50%);">
        {% if user.is_authenticated %}
            <span class="text-black font-semibold">Hello, {{ user.username }}!</span>
        {% else %}
            <div class="flex items-center gap-3">
                <a href="{% url 'login' %}">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Log in</button>
                </a>
                <a href="{% url 'signup' %}">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Sign up</button>
                </a>
            </div>
        {% endif %}
    </div>

</nav>

<!-- Create Club Modal -->
<div id="createClubModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-900">Create a Club</h2>
            <button id="closeClubModal" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="createClubForm">
            <div class="mb-4">
                <label for="clubName" class="block text-sm font-medium text-gray-700 mb-2">Club Name</label>
                <input type="text" id="clubName" name="club_name" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter club name" required maxlength="100" />
                <div id="clubNameError" class="hidden mt-2 text-sm text-red-600"></div>
            </div>
            
            <div class="flex justify-end gap-3">
                <button type="button" id="cancelClubBtn" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                    Create
                </button>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    const searchInput = document.getElementById('search');
    const searchDropdown = document.getElementById('searchDropdown');
    const recentSearchesList = document.getElementById('recentSearchesList');
    const searchResultsList = document.getElementById('searchResultsList');
    const noResults = document.getElementById('noResults');
    const recentSearchesSection = document.getElementById('recentSearches');
    let searchTimeout;
    let allClubs = [];

    // Load clubs dynamically - either from JSON script tag or fetch via AJAX
    function loadClubs() {
        // Try to get clubs from JSON script tag (passed from Django template)
        const clubsDataElement = document.getElementById('clubs-data');
        if (clubsDataElement) {
            try {
                const clubsData = JSON.parse(clubsDataElement.textContent);
                if (Array.isArray(clubsData) && clubsData.length > 0) {
                    allClubs = clubsData;
                    return;
                }
            } catch (e) {
                console.warn('Could not parse clubs data from template:', e);
            }
        }
        
        // Fallback: Fetch clubs via AJAX
        fetch('{% url "search_clubs" %}?q=')
            .then(response => response.json())
            .then(data => {
                allClubs = data.clubs.map(club => club.name);
            })
            .catch(error => {
                console.error('Error loading clubs:', error);
                // Fallback to empty array
                allClubs = [];
            });
    }

    // Load clubs on page load
    loadClubs();

    // Get recent searches from localStorage
    function getRecentSearches() {
        const recent = localStorage.getItem('clubRecentSearches');
        return recent ? JSON.parse(recent) : [];
    }

    // Save recent searches to localStorage
    function saveRecentSearches(searches) {
        localStorage.setItem('clubRecentSearches', JSON.stringify(searches));
    }

    // Add a club to recent searches
    function addToRecentSearches(clubName) {
        let recent = getRecentSearches();
        // Remove if already exists
        recent = recent.filter(c => c !== clubName);
        // Add to beginning
        recent.unshift(clubName);
        // Keep only last 5
        recent = recent.slice(0, 5);
        saveRecentSearches(recent);
        renderRecentSearches();
    }

    // Remove a club from recent searches
    function removeRecentSearch(clubName) {
        let recent = getRecentSearches();
        recent = recent.filter(c => c !== clubName);
        saveRecentSearches(recent);
        renderRecentSearches();
    }

    // Render recent searches
    function renderRecentSearches() {
        const recent = getRecentSearches();
        recentSearchesList.innerHTML = '';
        
        if (recent.length === 0) {
            recentSearchesSection.style.display = 'none';
            return;
        }
        
        recentSearchesSection.style.display = 'block';
        recent.forEach(clubName => {
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer group';
            
            // Create span with click handler
            const span = document.createElement('span');
            span.className = 'text-sm text-gray-700 flex-1';
            span.textContent = clubName; // Use textContent to prevent XSS
            span.addEventListener('click', function() {
                // For recent searches, we need to fetch the club ID
                fetch('{% url "search_clubs" %}?q=' + encodeURIComponent(clubName))
                    .then(response => response.json())
                    .then(data => {
                        if (data.clubs.length > 0) {
                            selectClub(clubName, data.clubs[0].id);
                        } else {
                            selectClub(clubName, null);
                        }
                    })
                    .catch(error => {
                        selectClub(clubName, null);
                    });
            });
            
            // Create remove button
            const removeBtn = document.createElement('button');
            removeBtn.className = 'opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-gray-200 rounded';
            removeBtn.innerHTML = `
                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            `;
            removeBtn.addEventListener('click', function(event) {
                event.stopPropagation();
                removeRecentSearch(clubName);
            });
            
            item.appendChild(span);
            item.appendChild(removeBtn);
            recentSearchesList.appendChild(item);
        });
    }

    // Filter clubs based on search query
    function filterClubs(query) {
        if (!query) {
            return allClubs;
        }
        const lowerQuery = query.toLowerCase();
        return allClubs.filter(club => club.toLowerCase().includes(lowerQuery));
    }

    // Render search results
    function renderSearchResults(query) {
        // Fetch clubs with IDs from the server
        fetch('{% url "search_clubs" %}?q=' + encodeURIComponent(query))
            .then(response => response.json())
            .then(data => {
                searchResultsList.innerHTML = '';
                
                if (data.clubs.length === 0) {
                    noResults.classList.remove('hidden');
                    searchResultsList.classList.add('hidden');
                } else {
                    noResults.classList.add('hidden');
                    searchResultsList.classList.remove('hidden');
                    data.clubs.forEach(club => {
                        const item = document.createElement('div');
                        item.className = 'p-2 hover:bg-gray-50 rounded cursor-pointer';
                        
                        const span = document.createElement('span');
                        span.className = 'text-sm text-gray-700';
                        span.textContent = club.name; // Use textContent to prevent XSS
                        span.addEventListener('click', function() {
                            selectClub(club.name, club.id);
                        });
                        
                        item.appendChild(span);
                        searchResultsList.appendChild(item);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching clubs:', error);
            });
    }

    // Handle search input
    function handleSearch() {
        const query = searchInput.value.trim();
        
        if (query) {
            // Show search results, hide recent searches
            recentSearchesSection.style.display = 'none';
            renderSearchResults(query);
        } else {
            // Show recent searches, hide search results
            recentSearchesSection.style.display = 'block';
            searchResultsList.innerHTML = '';
            noResults.classList.add('hidden');
            renderRecentSearches();
        }
    }

    // Select a club
    function selectClub(clubName, clubId) {
        searchInput.value = clubName;
        addToRecentSearches(clubName);
        searchDropdown.classList.add('hidden');
        // Navigate to club page if ID is provided
        if (clubId) {
            window.location.href = '/club/' + clubId + '/';
        }
    }

    // Show dropdown on focus and refresh clubs to get latest data
    searchInput.addEventListener('focus', function() {
        // Refresh clubs when opening dropdown to get latest data
        fetch('{% url "search_clubs" %}?q=')
            .then(response => response.json())
            .then(data => {
                allClubs = data.clubs.map(club => club.name);
            })
            .catch(error => {
                console.error('Error refreshing clubs:', error);
            });
        
        searchDropdown.classList.remove('hidden');
        handleSearch();
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const isClickInside = searchInput.contains(event.target) || searchDropdown.contains(event.target);
        if (!isClickInside) {
            searchDropdown.classList.add('hidden');
        }
    });

    // Handle search input with debounce
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(handleSearch, 150);
    });

    // Initial render of recent searches
    renderRecentSearches();
})();

// Profile Picture Dropdown and Upload
(function() {
    const profilePicBtn = document.getElementById('profilePicBtn');
    const profileDropdown = document.getElementById('profileDropdown');
    const profilePicUpload = document.getElementById('profile-picture-upload');
    
    if (profilePicBtn && profileDropdown) {
        // Toggle dropdown on profile picture click
        profilePicBtn.addEventListener('click', function(event) {
            event.stopPropagation();
            profileDropdown.classList.toggle('hidden');
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const isClickInside = profilePicBtn.contains(event.target) || profileDropdown.contains(event.target);
            if (!isClickInside) {
                profileDropdown.classList.add('hidden');
            }
        });
    }
    
    // Handle profile picture upload
    if (profilePicUpload) {
        profilePicUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                // Get CSRF token from cookie
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                const csrftoken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                
                const formData = new FormData();
                formData.append('profile_picture', file);
                if (csrftoken) {
                    formData.append('csrfmiddlewaretoken', csrftoken);
                }
                
                fetch('{% url "update_profile_picture" %}', {
                    method: 'POST',
                    body: formData,
                    headers: csrftoken ? {
                        'X-CSRFToken': csrftoken
                    } : {}
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the profile picture in the navbar
                        const profileImg = profilePicBtn.querySelector('img');
                        if (profileImg) {
                            profileImg.src = data.profile_picture_url + '?t=' + new Date().getTime();
                        } else {
                            // If no img exists, create one
                            const img = document.createElement('img');
                            img.src = data.profile_picture_url + '?t=' + new Date().getTime();
                            img.alt = 'Profile';
                            img.className = 'size-10 rounded-full bg-gray-800 outline -outline-offset-1 object-cover';
                            profilePicBtn.innerHTML = '';
                            profilePicBtn.appendChild(img);
                        }
                        profileDropdown.classList.add('hidden');
                        // Reload page to update profile picture everywhere
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error uploading profile picture:', error);
                    alert('Error uploading profile picture. Please try again.');
                });
            }
        });
        
        // Handle remove profile picture
        const removeProfilePictureBtn = document.getElementById('remove-profile-picture');
        if (removeProfilePictureBtn) {
            removeProfilePictureBtn.addEventListener('click', function(event) {
                event.preventDefault();
                
                // Get CSRF token
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                const csrftoken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                
                fetch('{% url "remove_profile_picture" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        profileDropdown.classList.add('hidden');
                        // Reload page to update profile picture everywhere
                        window.location.reload();
                    } else {
                        alert('Error removing profile picture. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error removing profile picture:', error);
                    alert('Error removing profile picture. Please try again.');
                });
            });
        }
    }
})();

// Create Club Modal
(function() {
    const createClubBtn = document.getElementById('createClubBtn');
    const createClubModal = document.getElementById('createClubModal');
    const closeClubModal = document.getElementById('closeClubModal');
    const cancelClubBtn = document.getElementById('cancelClubBtn');
    const createClubForm = document.getElementById('createClubForm');
    const clubNameInput = document.getElementById('clubName');
    const clubNameError = document.getElementById('clubNameError');
    
    if (createClubBtn && createClubModal) {
        // Open modal
        createClubBtn.addEventListener('click', function() {
            createClubModal.classList.remove('hidden');
            clubNameInput.focus();
        });
        
        // Close modal functions
        function closeModal() {
            createClubModal.classList.add('hidden');
            createClubForm.reset();
            clubNameError.classList.add('hidden');
            clubNameError.textContent = '';
        }
        
        closeClubModal.addEventListener('click', closeModal);
        cancelClubBtn.addEventListener('click', closeModal);
        
        // Close modal when clicking outside
        createClubModal.addEventListener('click', function(event) {
            if (event.target === createClubModal) {
                closeModal();
            }
        });
        
        // Handle form submission
        createClubForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const clubName = clubNameInput.value.trim();
            
            if (!clubName) {
                clubNameError.textContent = 'Club name is required';
                clubNameError.classList.remove('hidden');
                return;
            }
            
            // Get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            
            // Send AJAX request
            fetch('{% url "create_club" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'name': clubName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    // Reload page to show new club in left bar
                    window.location.reload();
                } else {
                    // Show error message
                    clubNameError.textContent = data.error || 'An error occurred';
                    clubNameError.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error creating club:', error);
                clubNameError.textContent = 'An error occurred. Please try again.';
                clubNameError.classList.remove('hidden');
            });
        });
    }
})();
</script>