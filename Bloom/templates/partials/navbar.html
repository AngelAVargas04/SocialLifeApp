<!-- NAVIGATION BAR -->
  {% load static %}
  {% csrf_token %}
  <!-- Pass clubs data to JavaScript -->
  {{ clubs|json_script:"clubs-data" }}
  <nav class="relative bg-white py-3 px-4 shadow-sm flex items-center">
    <!-- Left side: Profile Picture and Search -->
    <div class="flex items-center gap-4 flex-shrink-0" style="width: 240px;">
        <!-- Profile Picture with Dropdown -->
        {% if user.is_authenticated %}
        <div class="relative">
            <button id="profilePicBtn" class="relative flex rounded-full focus:outline-none cursor-pointer">
                {% if user.profile.profile_picture %}
                    <img src="{{ user.profile.profile_picture.url }}" alt="Profile" 
                        class="size-10 rounded-full bg-gray-800 outline -outline-offset-1 object-cover" />
                {% else %}
                    <div class="size-10 rounded-full bg-gray-300 outline -outline-offset-1 flex items-center justify-center text-gray-700 font-semibold text-sm">
                        {{ user.username|first|upper|default:"?" }}
                    </div>
                {% endif %}
            </button>
            
            <!-- Profile Dropdown Menu -->
            <div id="profileDropdown" class="hidden absolute left-0 top-full mt-2 w-64 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                <div class="p-4 border-b border-gray-200">
                    <p class="text-sm font-semibold text-gray-900">{{ user.username|default:"User" }}</p>
                    <p class="text-xs text-gray-500">{{ user.email|default:"" }}</p>
                </div>
                <div class="p-2">
                    <label for="profile-picture-upload" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded cursor-pointer">
                        Change Profile Picture
                        <input type="file" id="profile-picture-upload" accept="image/*" class="hidden" />
                    </label>
                    {% if user.profile.profile_picture %}
                    <button id="remove-profile-picture" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded cursor-pointer">
                        Remove Profile Picture
                    </button>
                    {% endif %}
                    <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-50 rounded">
                        Logout
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="max-w-xs w-full relative flex-1">
            <label for="search" class="block mb-2.5 text-sm font-medium text-heading sr-only">Search</label>
            <div class="relative">
                <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                    <svg class="w-4 h-4 text-body" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="m21 21-3.5-3.5M17 10a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z"/>
                    </svg>
                </div>
            
                <input type="search" id="search" 
                    class="rounded-full w-full p-2 ps-9 bg-neutral-secondary-medium border border-default-medium text-heading text-sm focus:ring-brand focus:border-brand shadow-xs placeholder:text-body" 
                    placeholder="Search for groups" autocomplete="off" />
            
            </div>
            
            <!-- Dropdown Menu -->
            <div id="searchDropdown" class="hidden absolute top-full left-0 right-0 mt-2 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-96 overflow-y-auto">
                <!-- Recent Searches Section -->
                <div id="recentSearches" class="border-b border-gray-200 p-3">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Recent Searches</h3>
                    </div>
                    <div id="recentSearchesList" class="space-y-1">
                        <!-- Recent searches will be populated here -->
                    </div>
                </div>
                
                <!-- Search Results Section -->
                <div id="searchResults" class="p-3">
                    <div id="searchResultsList" class="space-y-1">
                        <!-- Search results will be populated here -->
                    </div>
                    <div id="noResults" class="hidden text-center text-gray-500 py-4 text-sm">
                        No clubs found
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Center: Logo -->
    <div class="flex-1 flex justify-center">
        <a href="{% url 'home' %}">
            <img src="{% static 'image/logo_Bloom_BW.svg' %}" alt="Bloom Logo" class="h-12 mx-auto" />
        </a>
    </div>

    <!-- Right side: Hello text or Login/Signup buttons -->
    <div class="flex items-center justify-end flex-shrink-0" style="width: 224px;">
        {% if user.is_authenticated %}
            <span class="text-black font-semibold">Hello, {{ user.username }}!</span>
        {% else %}
            <div class="flex items-center gap-3">
                <a href="{% url 'login' %}">
                    <button class="m-8 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Log in</button>
                </a>
                <a href="{% url 'signup' %}">
                    <button class="ms-8 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Sign up</button>
                </a>
            </div>
        {% endif %}
    </div>

</nav>

<script>
(function() {
    const searchInput = document.getElementById('search');
    const searchDropdown = document.getElementById('searchDropdown');
    const recentSearchesList = document.getElementById('recentSearchesList');
    const searchResultsList = document.getElementById('searchResultsList');
    const noResults = document.getElementById('noResults');
    const recentSearchesSection = document.getElementById('recentSearches');
    let searchTimeout;
    let allClubs = [];

    // Load clubs dynamically - either from JSON script tag or fetch via AJAX
    function loadClubs() {
        // Try to get clubs from JSON script tag (passed from Django template)
        const clubsDataElement = document.getElementById('clubs-data');
        if (clubsDataElement) {
            try {
                const clubsData = JSON.parse(clubsDataElement.textContent);
                if (Array.isArray(clubsData) && clubsData.length > 0) {
                    allClubs = clubsData;
                    return;
                }
            } catch (e) {
                console.warn('Could not parse clubs data from template:', e);
            }
        }
        
        // Fallback: Fetch clubs via AJAX
        fetch('{% url "search_clubs" %}?q=')
            .then(response => response.json())
            .then(data => {
                allClubs = data.clubs.map(club => club.name);
            })
            .catch(error => {
                console.error('Error loading clubs:', error);
                // Fallback to empty array
                allClubs = [];
            });
    }

    // Load clubs on page load
    loadClubs();

    // Get recent searches from localStorage
    function getRecentSearches() {
        const recent = localStorage.getItem('clubRecentSearches');
        return recent ? JSON.parse(recent) : [];
    }

    // Save recent searches to localStorage
    function saveRecentSearches(searches) {
        localStorage.setItem('clubRecentSearches', JSON.stringify(searches));
    }

    // Add a club to recent searches
    function addToRecentSearches(clubName) {
        let recent = getRecentSearches();
        // Remove if already exists
        recent = recent.filter(c => c !== clubName);
        // Add to beginning
        recent.unshift(clubName);
        // Keep only last 5
        recent = recent.slice(0, 5);
        saveRecentSearches(recent);
        renderRecentSearches();
    }

    // Remove a club from recent searches
    function removeRecentSearch(clubName) {
        let recent = getRecentSearches();
        recent = recent.filter(c => c !== clubName);
        saveRecentSearches(recent);
        renderRecentSearches();
    }

    // Render recent searches
    function renderRecentSearches() {
        const recent = getRecentSearches();
        recentSearchesList.innerHTML = '';
        
        if (recent.length === 0) {
            recentSearchesSection.style.display = 'none';
            return;
        }
        
        recentSearchesSection.style.display = 'block';
        recent.forEach(clubName => {
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer group';
            item.innerHTML = `
                <span class="text-sm text-gray-700 flex-1" onclick="selectClub('${clubName}')">${clubName}</span>
                <button onclick="removeRecentSearchHandler('${clubName}')" class="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-gray-200 rounded">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            recentSearchesList.appendChild(item);
        });
    }

    // Filter clubs based on search query
    function filterClubs(query) {
        if (!query) {
            return allClubs;
        }
        const lowerQuery = query.toLowerCase();
        return allClubs.filter(club => club.toLowerCase().includes(lowerQuery));
    }

    // Render search results
    function renderSearchResults(query) {
        const results = filterClubs(query);
        searchResultsList.innerHTML = '';
        
        if (results.length === 0) {
            noResults.classList.remove('hidden');
            searchResultsList.classList.add('hidden');
        } else {
            noResults.classList.add('hidden');
            searchResultsList.classList.remove('hidden');
            results.forEach(clubName => {
                const item = document.createElement('div');
                item.className = 'p-2 hover:bg-gray-50 rounded cursor-pointer';
                item.innerHTML = `<span class="text-sm text-gray-700" onclick="selectClub('${clubName}')">${clubName}</span>`;
                searchResultsList.appendChild(item);
            });
        }
    }

    // Handle search input
    function handleSearch() {
        const query = searchInput.value.trim();
        
        if (query) {
            // Show search results, hide recent searches
            recentSearchesSection.style.display = 'none';
            renderSearchResults(query);
        } else {
            // Show recent searches, hide search results
            recentSearchesSection.style.display = 'block';
            searchResultsList.innerHTML = '';
            noResults.classList.add('hidden');
            renderRecentSearches();
        }
    }

    // Select a club
    window.selectClub = function(clubName) {
        searchInput.value = clubName;
        addToRecentSearches(clubName);
        searchDropdown.classList.add('hidden');
        // You can add navigation logic here, e.g., redirect to club page
        console.log('Selected club:', clubName);
    };

    // Remove recent search handler
    window.removeRecentSearchHandler = function(clubName) {
        event.stopPropagation();
        removeRecentSearch(clubName);
    };

    // Show dropdown on focus and refresh clubs to get latest data
    searchInput.addEventListener('focus', function() {
        // Refresh clubs when opening dropdown to get latest data
        fetch('{% url "search_clubs" %}?q=')
            .then(response => response.json())
            .then(data => {
                allClubs = data.clubs.map(club => club.name);
            })
            .catch(error => {
                console.error('Error refreshing clubs:', error);
            });
        
        searchDropdown.classList.remove('hidden');
        handleSearch();
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const isClickInside = searchInput.contains(event.target) || searchDropdown.contains(event.target);
        if (!isClickInside) {
            searchDropdown.classList.add('hidden');
        }
    });

    // Handle search input with debounce
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(handleSearch, 150);
    });

    // Initial render of recent searches
    renderRecentSearches();
})();

// Profile Picture Dropdown and Upload
(function() {
    const profilePicBtn = document.getElementById('profilePicBtn');
    const profileDropdown = document.getElementById('profileDropdown');
    const profilePicUpload = document.getElementById('profile-picture-upload');
    
    if (profilePicBtn && profileDropdown) {
        // Toggle dropdown on profile picture click
        profilePicBtn.addEventListener('click', function(event) {
            event.stopPropagation();
            profileDropdown.classList.toggle('hidden');
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const isClickInside = profilePicBtn.contains(event.target) || profileDropdown.contains(event.target);
            if (!isClickInside) {
                profileDropdown.classList.add('hidden');
            }
        });
    }
    
    // Handle profile picture upload
    if (profilePicUpload) {
        profilePicUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                // Get CSRF token from cookie
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                const csrftoken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                
                const formData = new FormData();
                formData.append('profile_picture', file);
                if (csrftoken) {
                    formData.append('csrfmiddlewaretoken', csrftoken);
                }
                
                fetch('{% url "update_profile_picture" %}', {
                    method: 'POST',
                    body: formData,
                    headers: csrftoken ? {
                        'X-CSRFToken': csrftoken
                    } : {}
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the profile picture in the navbar
                        const profileImg = profilePicBtn.querySelector('img');
                        if (profileImg) {
                            profileImg.src = data.profile_picture_url + '?t=' + new Date().getTime();
                        } else {
                            // If no img exists, create one
                            const img = document.createElement('img');
                            img.src = data.profile_picture_url + '?t=' + new Date().getTime();
                            img.alt = 'Profile';
                            img.className = 'size-10 rounded-full bg-gray-800 outline -outline-offset-1 object-cover';
                            profilePicBtn.innerHTML = '';
                            profilePicBtn.appendChild(img);
                        }
                        profileDropdown.classList.add('hidden');
                        // Reload page to update profile picture everywhere
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error uploading profile picture:', error);
                    alert('Error uploading profile picture. Please try again.');
                });
            }
        });
        
        // Handle remove profile picture
        const removeProfilePictureBtn = document.getElementById('remove-profile-picture');
        if (removeProfilePictureBtn) {
            removeProfilePictureBtn.addEventListener('click', function(event) {
                event.preventDefault();
                
                // Get CSRF token
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                const csrftoken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                
                fetch('{% url "remove_profile_picture" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        profileDropdown.classList.add('hidden');
                        // Reload page to update profile picture everywhere
                        window.location.reload();
                    } else {
                        alert('Error removing profile picture. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error removing profile picture:', error);
                    alert('Error removing profile picture. Please try again.');
                });
            });
        }
    }
})();
</script>